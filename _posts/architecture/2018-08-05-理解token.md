---
layout: post
title: 理解token
category: 软件架构
tags: token
---

### 为什么会有token？
wiki上的定义:

> In computer systems, an access token contains the security credentials for a login session and identifies the user, the user's groups, the user's privileges, and, in some cases, a particular application.

按照定义，token是个credentials，证书，一个凭证，这东西首先有“书”的特性，记录了一些信息，并不是简单的一个密码，而且也不行session id一样，一会就改变。也可以理解，就是一种信息的格式的约定。

有个Oauth的协议，是需要使用token的也就是说，至少在第三方鉴权的上，这个token是有作用的，能够不把用户密码信息发送给第三方的应用从而安全的简单的进行授权。

另外在app中和web中，现在有了restful，目前应用非常广泛。

标准？个人理解JWT是个token的实现的标准，官网的说明：
> JSON Web Tokens are an open, industry standard RFC 7519 method for representing claims securely between two parties.

另外在官网上[https://jwt.io/](https://jwt.io/)也有生成的工具，具体的格式也不复杂，header、payload、verify signature，注意，前两个是Base64编码的并没有加密，第三个verify signature，作用只是验证是不是自己发布的，token有没有被其他人修改过。

### 为什么header和payload是Base64编码的？

就要求token里面不能存放敏感信息。为什么要Base64？个人感觉还是为了简单，关键token的左右只是个证书，而不是密码的超级加密变种。

而且token有个过期时间，很多时候就是服务端生成个token，然后有效期10分钟，这样的话，如果token被抓到了，岂不是能够模仿用户的行为？

### token泄漏后还安全么？

不安全。怎么办？推荐使用https，能够保证链路层的的安全，至于客户端包括app和web的token泄露，基本无力解决。

参考[OAuth 2.0 Threat Model and Security Considerations](https://tools.ietf.org/html/rfc6819)

> 4.1.3.  Threat: Obtaining Access Tokens
> 
>    Depending on the client type, there are different ways that access
>    tokens may be revealed to an attacker.  Access tokens could be stolen
>    from the device if the application stores them in a storage device
>    that is accessible to other applications.
> 
>    Impact: Where the token is a bearer token and no additional mechanism
>    is used to identify the client, the attacker can access all resources
>    associated with the token and its scope.
> 
>    Countermeasures:
> 
>    o  Keep access tokens in transient memory and limit grants
>       (Section 5.1.6).
> 
>    o  Limit token scope (Section 5.1.5.1).
> 
>    o  Keep access tokens in private memory or apply same protection
>       means as for refresh tokens (Section 5.2.2).
> 
>    o  Keep access token lifetime short (Section 5.1.5.3).

> 4.4.2.1.  Threat: Access Token Leak in Transport/Endpoints
> 
>    This token might be eavesdropped by an attacker.  The token is sent
>    from the server to the client via a URI fragment of the redirect URI.
>    If the communication is not secured or the endpoint is not secured,
>    the token could be leaked by parsing the returned URI.
> 
>    Impact: The attacker would be able to assume the same rights granted
>    by the token.
> 
>    Countermeasures:
> 
>    o  The authorization server should ensure confidentiality (e.g.,
>       using TLS) of the response from the authorization server to the
>       client (see Section 5.1.1).
> 4.4.2.2.  Threat: Access Token Leak in Browser History
> 
>    An attacker could obtain the token from the browser's history.  Note
>    that this means the attacker needs access to the particular device.
> 
>    Countermeasures:
> 
>    o  Use short expiry time for tokens (see Section 5.1.5.3).  Reduced
>       scope of the token may reduce the impact of that attack (see
>       Section 5.1.5.1).
> 
>    o  Make responses non-cacheable.

以上，手段只是预防的，如使用https、把token的生命周期搞短、尽量限制token的权限范围、设置浏览器缓存的过期时间。

### cookie也是解决无状态问题的，token哪里高级了？

cookie的诞生确实是为了解决无状态的问题，但是现在基本不用这个功能了，最重要的就是有大小的限制4k，现在cookie里面也可以放session id或者token。

cookie解决无状态的问题是与session的方式对比比较好解决，与token并不是一个维度的。

token，就像开头说的，是个证书，只是代表了一类资源的权限，另外一般用token，也可以在后台有对应的用户的session，存储一些回话的状态，但是在大多数情况下，restful的场景，是无状态的，也就是token与状态甚至都没啥关系。

### restful中只有token没有session么？



### 实现restful的无状态，是否比有状态的session的方式复杂？

## 参考
[Oauth的access token 安全么?](https://www.zhihu.com/question/20274730)  
[app开发token、cookie的区别，账号密码加密又是如何保证安全？](https://www.zhihu.com/question/39137156/answer/80228149)  
[理解OAuth 2.0](http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html)  
[Oauth协议rfc](https://tools.ietf.org/html/rfc6749)  
[会话是否真的违反RESTfulness？](https://codeday.me/bug/20170414/2826.html)  